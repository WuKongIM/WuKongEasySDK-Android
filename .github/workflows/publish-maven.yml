# WuKongIM Android EasySDK - Modern Portal API Publishing Workflow
# Streamlined workflow using only Central Publisher Portal API
# Generates all required artifacts with checksums and signatures

name: 📦 Publish to Maven Central via Portal API

on:
  # Trigger on version tags (e.g., v1.0.0, v1.2.3, v2.0.0-beta.1)
  push:
    tags:
      - 'v*'
  
  # Allow manual triggering for testing and emergency releases
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string
      dry_run:
        description: 'Perform a dry run (build without publishing)'
        required: false
        type: boolean
        default: false

# Ensure only one publishing workflow runs at a time
concurrency:
  group: publish-maven-portal
  cancel-in-progress: false

jobs:
  publish:
    name: 🚀 Build and Publish to Maven Central
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run != 'true'
    
    environment: 
      name: maven-central
      url: https://search.maven.org/artifact/com.githubim/easysdk-android
    
    steps:
      # Step 1: Checkout the repository
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper version detection
      
      # Step 2: Extract version from tag or input
      - name: 🏷️ Extract Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Using manual version: $VERSION"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "Using tag version: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Publishing version: $VERSION"
      
      # Step 3: Set up Java JDK 17
      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      # Step 4: Cache Gradle dependencies
      - name: 📦 Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      # Step 5: Make Gradle wrapper executable
      - name: 🔧 Make Gradle Wrapper Executable
        run: chmod +x gradlew
      
      # Step 6: Validate Gradle wrapper
      - name: ✅ Validate Gradle Wrapper
        uses: gradle/actions/wrapper-validation@v3
      
      # Step 7: Configure GPG signing
      - name: 🔐 Configure GPG Signing
        run: |
          echo "Setting up GPG signing..."
          
          # Create .gnupg directory if it doesn't exist
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          
          # Create GPG key file from secret
          if [ -z "${{ secrets.GPG_PRIVATE_KEY }}" ]; then
            echo "Error: GPG_PRIVATE_KEY secret is not set"
            exit 1
          fi
          
          # Decode base64 GPG private key
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | base64 --decode > $HOME/private.key
          
          # Verify the key file was created and has content
          if [ ! -s "$HOME/private.key" ]; then
            echo "Error: GPG private key file is empty after decoding"
            exit 1
          fi
          
          # Import the GPG key
          echo "Importing GPG private key..."
          gpg --batch --yes --import $HOME/private.key
          
          # List imported keys to verify
          echo "Imported GPG keys:"
          gpg --list-secret-keys --keyid-format LONG
          
          # Set GPG configuration for non-interactive signing
          echo "use-agent" > ~/.gnupg/gpg.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "batch" >> ~/.gnupg/gpg.conf
          echo "no-tty" >> ~/.gnupg/gpg.conf
          
          # Configure GPG agent
          echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
          echo "default-cache-ttl 86400" >> ~/.gnupg/gpg-agent.conf
          echo "max-cache-ttl 86400" >> ~/.gnupg/gpg-agent.conf
          
          # Set proper permissions
          chmod 600 ~/.gnupg/gpg.conf
          chmod 600 ~/.gnupg/gpg-agent.conf
          
          # Restart GPG agent
          gpgconf --kill gpg-agent || true
          gpgconf --launch gpg-agent
          
          # Test GPG signing capability
          echo "Testing GPG signing capability..."
          echo "test content" > test-sign.txt
          
          if gpg --batch --yes --pinentry-mode loopback \
            --passphrase "${{ secrets.SIGNING_PASSWORD }}" \
            --armor --detach-sign \
            --default-key "${{ secrets.SIGNING_KEY_ID }}" \
            test-sign.txt; then
            echo "✅ GPG signing test successful"
            
            # Verify the signature
            if gpg --verify test-sign.txt.asc test-sign.txt 2>/dev/null; then
              echo "✅ GPG signature verification successful"
            else
              echo "⚠️ GPG signature verification failed"
            fi
          else
            echo "❌ GPG signing test failed"
            exit 1
          fi
          
          # Cleanup test files
          rm -f test-sign.txt test-sign.txt.asc
          
          echo "GPG signing configured and tested successfully"
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}

      # Step 8: Build, Sign, and Generate Checksums
      - name: 🔐 Build and Sign All Artifacts
        run: |
          echo "Building and signing all artifacts with checksums..."
          echo "Version: $VERSION"

          # Build and sign all artifacts including sources and javadoc
          ./gradlew clean build \
            androidSourcesJar \
            androidJavadocJar \
            publishToMavenLocal \
            --no-daemon \
            --stacktrace \
            --info \
            -Pversion=$VERSION

          echo "✅ All artifacts built and signed successfully"

          # Generate checksums for all artifacts
          MAVEN_LOCAL_DIR="$HOME/.m2/repository/com/githubim/easysdk-android/$VERSION"
          echo "Generating checksums in: $MAVEN_LOCAL_DIR"

          if [ -d "$MAVEN_LOCAL_DIR" ]; then
            cd "$MAVEN_LOCAL_DIR"

            # Generate MD5 and SHA1 checksums for all artifacts
            for file in *.aar *.pom *.jar; do
              if [ -f "$file" ]; then
                echo "Generating checksums for: $file"

                # Generate MD5 checksum
                md5sum "$file" | cut -d' ' -f1 > "${file}.md5"
                echo "✅ Generated MD5: ${file}.md5"

                # Generate SHA1 checksum
                sha1sum "$file" | cut -d' ' -f1 > "${file}.sha1"
                echo "✅ Generated SHA1: ${file}.sha1"
              fi
            done

            cd - > /dev/null

            echo "📦 Final artifacts with checksums and signatures:"
            ls -la "$MAVEN_LOCAL_DIR"

            # Verify we have all required files
            ARTIFACT_COUNT=$(find "$MAVEN_LOCAL_DIR" -name "*.aar" -o -name "*.pom" -o -name "*.jar" | grep -v "\.asc$" | wc -l)
            SIGNATURE_COUNT=$(find "$MAVEN_LOCAL_DIR" -name "*.asc" | wc -l)
            CHECKSUM_COUNT=$(find "$MAVEN_LOCAL_DIR" -name "*.md5" -o -name "*.sha1" | wc -l)

            echo "📊 Artifact summary:"
            echo "   - Artifacts: $ARTIFACT_COUNT"
            echo "   - Signatures: $SIGNATURE_COUNT"
            echo "   - Checksums: $CHECKSUM_COUNT"

            if [ "$SIGNATURE_COUNT" -gt 0 ] && [ "$CHECKSUM_COUNT" -gt 0 ]; then
              echo "✅ All artifacts have signatures and checksums"
              echo "artifacts_ready=true" >> $GITHUB_ENV
            else
              echo "❌ Missing signatures or checksums"
              echo "artifacts_ready=false" >> $GITHUB_ENV
            fi
          else
            echo "❌ Maven local repository directory not found"
            echo "artifacts_ready=false" >> $GITHUB_ENV
          fi
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}

      # Step 9: Portal API Health Check
      - name: 🔗 Portal API Health Check
        run: |
          echo "Verifying Portal API connectivity and permissions..."

          # Create base64 encoded credentials
          CREDENTIALS=$(echo -n "${{ secrets.OSSRH_USERNAME }}:${{ secrets.OSSRH_PASSWORD }}" | base64)

          # Test Portal API access
          echo "Testing Portal API access..."
          if curl -H "Authorization: Bearer $CREDENTIALS" \
            "https://central.sonatype.com/api/v1/publisher/deployments" \
            --fail --silent --max-time 30 > /dev/null; then
            echo "✅ Portal API access confirmed"
            echo "portal_api_available=true" >> $GITHUB_ENV
          else
            echo "❌ Portal API access failed"
            echo "portal_api_available=false" >> $GITHUB_ENV
            exit 1
          fi

          # Check namespace access
          echo "Checking namespace permissions..."
          NAMESPACES=$(curl -H "Authorization: Bearer $CREDENTIALS" \
            "https://central.sonatype.com/api/v1/publisher/namespaces" \
            --silent --max-time 30 | jq -r '.[].namespace' 2>/dev/null || echo "")

          if echo "$NAMESPACES" | grep -q "com.githubim"; then
            echo "✅ Namespace com.githubim access confirmed"
          else
            echo "⚠️ Namespace access may be limited"
            echo "Available namespaces: $NAMESPACES"
          fi
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}

      # Step 10: Create Portal API Bundle
      - name: 📦 Create Portal API Bundle
        if: env.portal_api_available == 'true' && env.artifacts_ready == 'true'
        run: |
          echo "Creating Portal API deployment bundle..."

          # Use Maven local repository as source (contains signed artifacts and checksums)
          MAVEN_LOCAL_DIR="$HOME/.m2/repository/com/githubim/easysdk-android/$VERSION"

          # Run bundle creation script with Maven local repository
          ./scripts/create-portal-bundle.sh $VERSION "$MAVEN_LOCAL_DIR"

          # Verify bundle was created
          if [ -f "central-bundle.zip" ]; then
            BUNDLE_SIZE=$(du -h central-bundle.zip | cut -f1)
            echo "✅ Bundle created successfully: central-bundle.zip ($BUNDLE_SIZE)"

            # Verify bundle contents include signatures and checksums
            echo "📋 Bundle contents:"
            unzip -l central-bundle.zip

            SIGNATURE_COUNT=$(unzip -l central-bundle.zip | grep -c "\.asc$" || echo "0")
            CHECKSUM_COUNT=$(unzip -l central-bundle.zip | grep -c -E "\.(md5|sha1)$" || echo "0")

            echo "📊 Bundle verification:"
            echo "   - Signature files: $SIGNATURE_COUNT"
            echo "   - Checksum files: $CHECKSUM_COUNT"

            if [ "$SIGNATURE_COUNT" -gt 0 ] && [ "$CHECKSUM_COUNT" -gt 0 ]; then
              echo "✅ Bundle contains all required files"
              echo "bundle_created=true" >> $GITHUB_ENV
            else
              echo "⚠️ Bundle missing required files"
              echo "bundle_created=false" >> $GITHUB_ENV
            fi
          else
            echo "❌ Failed to create bundle"
            echo "bundle_created=false" >> $GITHUB_ENV
          fi

      # Step 11: Upload to Portal API
      - name: 🚀 Upload to Portal API
        if: env.portal_api_available == 'true' && env.bundle_created == 'true'
        run: |
          echo "Uploading to Portal API..."

          # Create base64 encoded credentials
          CREDENTIALS=$(echo -n "${{ secrets.OSSRH_USERNAME }}:${{ secrets.OSSRH_PASSWORD }}" | base64)

          # Upload bundle to Portal API
          echo "Uploading bundle to Portal API..."

          # Capture both response and HTTP code
          UPLOAD_RESPONSE=$(curl -X POST \
            -H "Authorization: Bearer $CREDENTIALS" \
            -F "bundle=@central-bundle.zip" \
            -F "name=WuKongIM Android EasySDK v$VERSION" \
            "https://central.sonatype.com/api/v1/publisher/upload?publishingType=USER_MANAGED" \
            --silent --show-error --max-time 300 -w "%{http_code}")

          HTTP_CODE="${UPLOAD_RESPONSE: -3}"
          RESPONSE_BODY="${UPLOAD_RESPONSE%???}"

          echo "Portal API HTTP Code: $HTTP_CODE"
          echo "Portal API Response: $RESPONSE_BODY"

          if [ "$HTTP_CODE" = "201" ] && [ -n "$RESPONSE_BODY" ] && [ "$RESPONSE_BODY" != "null" ]; then
            DEPLOYMENT_ID="$RESPONSE_BODY"
            echo "✅ Portal API upload successful"
            echo "Deployment ID: $DEPLOYMENT_ID"
            echo "portal_deployment_id=$DEPLOYMENT_ID" >> $GITHUB_ENV
            echo "portal_upload_success=true" >> $GITHUB_ENV

            # Monitor deployment status
            echo "Monitoring deployment status..."
            for i in {1..10}; do
              STATUS=$(curl -X POST \
                -H "Authorization: Bearer $CREDENTIALS" \
                "https://central.sonatype.com/api/v1/publisher/status?id=$DEPLOYMENT_ID" \
                --silent | jq -r '.deploymentState' 2>/dev/null || echo "UNKNOWN")

              echo "Status check $i: $STATUS"

              case $STATUS in
                "VALIDATED")
                  echo "✅ Deployment validated and ready for manual release"
                  echo "🔗 View at: https://central.sonatype.com/publishing/deployments"
                  break
                  ;;
                "PUBLISHED")
                  echo "🎉 Deployment automatically published to Maven Central"
                  break
                  ;;
                "FAILED")
                  echo "❌ Deployment failed validation"
                  curl -X POST \
                    -H "Authorization: Bearer $CREDENTIALS" \
                    "https://central.sonatype.com/api/v1/publisher/status?id=$DEPLOYMENT_ID" \
                    --silent | jq '.errors' 2>/dev/null || echo "No error details available"
                  echo "portal_upload_success=false" >> $GITHUB_ENV
                  exit 1
                  ;;
                "PENDING"|"VALIDATING"|"PUBLISHING")
                  echo "⏳ Deployment in progress: $STATUS"
                  if [ $i -eq 10 ]; then
                    echo "⏰ Monitoring timeout - check Portal manually"
                    echo "🔗 View at: https://central.sonatype.com/publishing/deployments"
                  else
                    sleep 30
                  fi
                  ;;
                *)
                  echo "❓ Unknown status: $STATUS"
                  sleep 30
                  ;;
              esac
            done
          else
            echo "❌ Portal API upload failed"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"

            # Check for specific error types
            if echo "$RESPONSE_BODY" | grep -q "Invalid signature"; then
              echo "🔍 Signature validation error detected"
              echo "📋 This indicates GPG signing issues in the bundle"
            elif [ "$HTTP_CODE" = "401" ]; then
              echo "🔐 Authentication error - check Portal credentials"
            elif [ "$HTTP_CODE" = "400" ]; then
              echo "📦 Bundle format error - check bundle contents"
            fi

            echo "portal_upload_success=false" >> $GITHUB_ENV
            exit 1
          fi
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}

      # Step 12: Final Status Report
      - name: 📊 Final Publishing Status Report
        if: always()
        run: |
          echo ""
          echo "🎯 PUBLISHING STATUS REPORT"
          echo "================================"
          echo ""
          echo "📦 Version: $VERSION"
          echo "🔗 Portal API: $( [ "${{ env.portal_api_available }}" = "true" ] && echo "✅ Available" || echo "❌ Not Available" )"
          echo "📋 Artifacts: $( [ "${{ env.artifacts_ready }}" = "true" ] && echo "✅ Ready" || echo "❌ Not Ready" )"
          echo "📦 Bundle: $( [ "${{ env.bundle_created }}" = "true" ] && echo "✅ Created" || echo "❌ Failed" )"
          echo "🚀 Upload: $( [ "${{ env.portal_upload_success }}" = "true" ] && echo "✅ Successful" || echo "❌ Failed" )"

          if [ -n "${{ env.portal_deployment_id }}" ]; then
            echo "🆔 Deployment ID: ${{ env.portal_deployment_id }}"
          fi

          echo ""
          echo "📋 NEXT STEPS:"

          if [ "${{ env.portal_upload_success }}" = "true" ]; then
            echo "✅ Portal API Upload Successful:"
            echo "   1. 🔗 Visit: https://central.sonatype.com/publishing/deployments"
            echo "   2. 🔍 Find deployment: WuKongIM Android EasySDK v$VERSION"
            echo "   3. ✅ Review validation results"
            echo "   4. 🚀 Manually release to Maven Central (if validated)"
            echo "   5. 📊 Monitor release progress"
          else
            echo "❌ Portal API Upload Failed:"
            echo "   1. 🔍 Review workflow logs for errors"
            echo "   2. 🔐 Verify authentication credentials"
            echo "   3. 📦 Check bundle contents and signatures"
            echo "   4. 🔧 Fix issues and retry"
          fi

          echo ""
          echo "🔗 USEFUL LINKS:"
          echo "   • Central Publisher Portal: https://central.sonatype.com/publishing/deployments"
          echo "   • Maven Central Search: https://search.maven.org/artifact/com.githubim/easysdk-android"
          echo "   • Documentation: https://central.sonatype.org/publish/"
          echo "   • Support: central-support@sonatype.com"

          echo ""
          echo "🎉 Publishing workflow completed!"

      # Step 13: Clean up sensitive files
      - name: 🧹 Clean Up Sensitive Files
        if: always()
        run: |
          echo "Cleaning up sensitive files..."
          rm -f $HOME/private.key
          rm -f central-bundle.zip
          rm -f central-bundle.zip.metadata
          # Clean up GPG agent
          gpgconf --kill gpg-agent || true
          echo "Cleanup completed"
